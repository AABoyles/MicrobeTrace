<!DOCTYPE html>
<!--html lang="en" manifest="microbetrace.appcache"-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MicrobeTrace</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116308624-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-116308624-1');
  </script>
  <link rel="icon" type="image/png" href="img/icon.ico" />
  <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/golden-layout/src/css/goldenlayout-base.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/golden-layout/src/css/goldenlayout-light-theme.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/vis/dist/vis.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/chosen-js/chosen.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/alertifyjs/build/css/alertify.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/open-iconic/font/css/open-iconic-bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/main.css" />
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-xl navbar-light bg-light">
    <ul class="nav mr-auto">
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">File</a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item" data-toggle="modal" data-target="#save_modal">Save</a>
          <a href="#" id="ExportDataTab" class="dropdown-item" data-toggle="modal" data-target="#export_modal">Export Data</a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <input type="file" class="d-none" id="OpenTab" />
            <label class="mb-0" for="OpenTab">Open</label>
          </a>
          <a href="#" class="dropdown-item">
            <input type="file" class="d-none" id="ImportTab" />
            <label class="mb-0" for="ImportTab">Import</label>
          </a>
          <a href="#" id="FileTab" class="dropdown-item">New</a>
          <div class="dropdown-divider"></div>
          <a href="#" id="ExitTab" class="dropdown-item">Exit</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Edit</a>
        <div class="dropdown-menu">
          <a href="#" id="FindTab" class="dropdown-item">Find</a>
          <a href="#" id="AddDataTab" class="dropdown-item">Add Data</a>
          <a href="#" id="RevealAllTab" class="dropdown-item">Reveal All</a>
          <div class="dropdown-divider"></div>
          <a href="#" id="SettingsTab"  class="dropdown-item" data-toggle="modal" data-target="#global_settings_modal">Settings</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">View</a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item viewbutton" data-href="2d_network">2D Network</a>
          <a href="#" class="dropdown-item viewbutton" data-href="3d_network">3D Network</a>
          <a href="#" class="dropdown-item viewbutton" data-href="histogram">Histogram</a>
          <a href="#" class="dropdown-item viewbutton" data-href="table">Table</a>
          <a href="#" class="dropdown-item viewbutton" data-href="flow_diagram">Flow Diagram</a>
          <a href="#" class="dropdown-item viewbutton" data-href="scatterplot">Scatterplot</a>
          <a href="#" class="dropdown-item viewbutton" data-href="geo_map">Map</a>
          <a href="#" class="dropdown-item viewbutton" data-href="timeline">Timeline</a>
          <div class="dropdown-divider showForSequence"></div>
          <a href="#" class="dropdown-item viewbutton showForSequence" data-href="sequences">Sequences</a>
          <a href="#" class="dropdown-item viewbutton showForSequence" data-href="heatmap">Heatmap</a>
          <a href="#" class="dropdown-item viewbutton showForSequence" data-href="phylogenetic_tree">Phylogenetic Tree</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Window</a>
        <div class="dropdown-menu">
          <a href="#" id="ReloadTab" class="dropdown-item">Reload</a>
          <div class="dropdown-divider"></div>
          <a href="#" id="FullScreenTab" class="dropdown-item">Toggle Full Screen</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Help</a>
        <div class="dropdown-menu">
          <a href="https://github.com/AABoyles/WebMicrobeTrace/wiki" class="dropdown-item" target="_blank">Help</a>
          <a href="https://github.com/AABoyles/WebMicrobeTrace/issues/new" class="dropdown-item" target="_blank">Report Bug</a>
          <div class="dropdown-divider"></div>
          <a href="#" id="InstallTab" class="dropdown-item" data-toggle="modal" data-target="#install-modal">Install</a>
          <a href="#" id="AboutTab" class="dropdown-item" data-toggle="modal" data-target="#about-modal">About</a>
        </div>
      </li>
    </ul>
    <form class="navbar-form navbar-right" role="search">
      <input type="search" id="search" class="form-control py-0" placeholder="Search" />
    </form>
  </nav>

  <div id="licenseAgreement" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="licenseAgreement">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="licenseAgreement" class="modal-title">License Agreement</h5>
        </div>
        <div class="modal-body">
          <pre>The material embodied in this software is provided to you "As-is" and without
warranty of any kind, express, implied or otherwise, including without
limitation, any warranty of fitness for a particular purpose. In no event shall
the Centers for Disease Control and Prevention (CDC) or the United States (U.S.)
government be liable to you or anyone else for any direct, special, incidental,
indirect or consequential damages of any kind, or any damages whatsoever,
including without limitation, loss of profit, loss of use, savings or revenue,
or the claims of third parties, whether or not CDC or the U.S. Government has
been advised of the possibility of such loss, however caused and on any theory
of liability, arising out of or in connection with the possession, use or
performance of this software.</pre>
          <p>Please Click "Accept" to accept this agreement, or "Reject" to close this application.</p>
        </div>
        <div class="modal-footer">
          <button id="rejectAgreement" type="button" class="btn btn-danger" data-dismiss="modal">Reject</button>
          <button id="acceptAgreement" type="button" class="btn btn-primary" data-dismiss="modal">Accept</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="loadingInformationModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Loading File</h5>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <img src="img/1DNA.gif" alt="Loading Spinner" />
          </div>
          <a class="btn btn-primary" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">Details</a>
          <div class="collapse" id="collapseExample">
            <div id="loadingInformation" class="card card-body"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="loadCancelButton" class="btn btn-error btn-sm pull-right">Cancel</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="main_panel" class="pane-container pane-horizontal">
    <noscript class="container-fluid">
      <div class="jumbotron">
        <h1>Sorry!</h1>
        <p class="lead">MicrobeTrace requires Javascript to run. Please enable Javascript and refresh MicrobeTrace.</p>
      </div>
    </noscript>
  </div>

  <span id="tooltip"></span>

  <div id="save_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save MicrobeTrace Session</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="save-file-name" class="form-control form-control-sm" placeholder="Filename" />
            </div>
            <div class="col-3">
              <select class="form-control form-control-sm">
                <option selected>microbetrace</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="SaveTab" class="btn btn-primary" data-dismiss="modal">Export</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="global_settings_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Global Configurations</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="global-tab" data-toggle="tab" href="#global-config" role="tab" aria-controls="home" aria-selected="true">Filtering</a>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="global-config" role="tabpanel" aria-labelledby="nodes-tab">
              <div class="form-group row">
                <div class="col-4"><label for="linkSortVariable" data-toggle="tooltip" title="By what variable would you like to prune links from the network?">Prune Links on</label></div>
                <div class="col-8"><select id="linkSortVariable" class="custom-select custom-select-sm linkVariables"><option value="distance" selected>Distance</option></select></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><a data-toggle="tooltip" title="What's the maximum genetic distance you're willing to call a link?">Pruning Threshold</a></div>
                <div class="col-8"><svg id="link-threshold-sparkline"></svg></div>
                <div class="col-8 offset-4"><input type="number" class="form-control custom-select-sm" id="default-link-threshold" value="0.015" step="0.001" /></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label for="computeMST" data-toggle="tooltip" title="Would you like to restrict links to the Minimum Spanning Tree?">Minimum Spanning Tree</label></div>
                <div class="col-8">
                  <button id="computeMST" class="btn btn-secondary btn-sm showForNotMST">Compute MST</button>
                  <div class="btn-group btn-group-toggle btn-group-sm showForMST" data-toggle="buttons">
                    <label class="btn btn-secondary active">
                      <input type="radio" name="MSTOptions" id="showAllLinks" autocomplete="off" checked> All
                    </label>
                    <label class="btn btn-secondary">
                      <input type="radio" name="MSTOptions" id="showMSTLinks" autocomplete="off"> MST
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label for="ShowSingletons" data-toggle="tooltip" title="Would you like to show or hide nodes with no visible links?">Singletons</label></div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons">
                    <label class="btn btn-secondary active">
                      <input type="radio" name="singletons" id="ShowSingletons" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-secondary">
                      <input type="radio" name="singletons" id="HideSingletons" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="btn-group" data-toggle="buttons">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Done</button>
          </div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="export_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="export-file-name" class="form-control form-control-sm" placeholder="Filename" />
            </div>
            <div class="col-3">
              <select id="export-file-format" class="form-control form-control-sm">
                <option selected>hivtrace</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="export-data" class="btn btn-primary" data-dismiss="modal">Export</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div class="modal fade" id="install-modal" tabindex="-1" role="dialog" aria-labelledby="install-modal-label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="install-modal-label">Install MicrobeTrace</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <p class="on-chrome">To Install, Click on Chrome Options > More Tools > Add to Taskbar, and click "OK". (<a href="https://support.google.com/chrome_webstore/answer/3060053?hl=en">See here for more</a>)</p>
          <p class="on-edge">To Install, Click on the browser options, and then "Pin this ppage to Start".</p>
          <p class="on-ie">To Install, Click on the Gear Icon and Select "Add site to Apps"</p>
          <p class="on-firefox"></p>
          <p class="">To Create a Link on your Desktop, drag this link to your Desktop:</p>
          <p class="text-center"><a href="https://aaboyles.github.com/WebMicrobeTrace">MicrobeTrace</a></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">About MicrobeTrace</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <h3>MicrobeTrace</h3>
          MicrobeTrace is a desktop application that renders existing data from high-risk contact networks in an easy-to-use Graphical User Interface (GUI). The network visualization can be customized according to supplemental data sources and mathematical inferences like the most probable transmission pathways. MicrobeTrace is a highly responsive, visual sequence analytics tool which can reduce the gap between data production and analytics and help you to discover, understand, and display relationships between patients (nodes). As a standalone desktop application, MicrobeTrace can be deployed on laptops to locations without any Internet access, thereby reducing both the startup cost and analysis time and effort.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts/polyfills.js"></script>
  <script src="node_modules/underscore/underscore-min.js"></script>
  <script src="node_modules/udc/udc.js"></script>
  <script src="node_modules/vue/dist/vue.min.js"></script>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="node_modules/golden-layout/dist/goldenlayout.min.js"></script>
  <script src="node_modules/papaparse/papaparse.min.js"></script>
  <script src="node_modules/xss/dist/xss.min.js"></script>
  <script src="node_modules/d3/dist/d3.min.js"></script>
  <script src="node_modules/plotly.js/dist/plotly.min.js"></script>
  <script src="node_modules/alertifyjs/build/alertify.min.js"></script>
  <script src="vendor/FileSaver.min.js"></script>
  <script src="node_modules/html2canvas/dist/html2canvas.min.js"></script>
  <script src="node_modules/screenfull/dist/screenfull.js"></script>
  <script src="node_modules/clipboard/dist/clipboard.min.js"></script>
  <script src="vendor/bootstrap-filestyle.min.js"></script>
  <script src="node_modules/chosen-js/chosen.jquery.min.js"></script>
  <script src="scripts/common.js"></script>
  <script>
  $(function(){
    'use strict';

    if(navigator.onLine && window.applicationCache.status !== window.applicationCache.UNCACHED){
      window.applicationCache.update();
      if(window.applicationCache.status === window.applicationCache.UPDATEREADY){
        window.applicationCache.swapCache();
      }
    }

    window.session = app.sessionSkeleton();

    window.layout = new window.GoldenLayout({
      settings: {
        selectionEnabled: true,
        showPopoutIcon: false
      },
      content: [{
        type: 'stack',
        content: []
      }]
    }, $('#main_panel'));

    layout.init();

    layout.contentItems = [];

    app.launchView('files');

    // Before anything else gets done, ask the user to accept the legal agreement
    if(!localStorage.getItem('licenseAccepted')){
      $('#acceptAgreement').click(function(){
        // Set that agreement in localStorage
        localStorage.setItem('licenseAccepted', new Date());
      });
      $('#rejectAgreement').click(function(){
        // If you don't agree, no app for you!
        //TODO: Show a message indicating you are not permitted to use the app without agreeing to the terms of use.
      });
      // No hacking around the agreement.
      $('#licenseAgreement').modal({
        backdrop: 'static',
        keyboard: false
      });
    }

    // Let's set up the Nav Bar
    $('#FileTab').click(app.reset);

    $('#SaveTab').click(function(){
      var blob = new Blob([JSON.stringify(session)], {type: 'application/json;charset=utf-8'});
      saveAs(blob, $('#save-file-name').val()+'.microbetrace');
    });

    $('#OpenTab').change(function(e){
      if(e.target.files.length > 0){
        var reader = new FileReader();
        reader.onloadend = function(out){
          session = JSON.parse(out.target.result);
          app.launchView('2d_network');
        };
        reader.readAsText(e.target.files[0], 'UTF-8');
      }
    });

    $('#ImportTab').change(function(e){
      if(e.target.files.length > 0){
        var reader = new FileReader();
        reader.onloadend = function(out){
          session = app.sessionSkeleton();
          app.parseHIVTrace(JSON.parse(out.target.result));
          app.launchView('2d_network');
          $('#linkSortVariable').html(
            session.data.linkFields.map(function(field){
              return '<option value="' + field + '"' + (field === 'distance' ? ' selected' : '') + '>' + app.titleize(field) + '</option>';
            }).join('\n')
          );
          try {
            app.updateThresholdHistogram();
          } catch(error){
            console.error(error);
            app.reset();
          }
          app.setLinkVisibility();
          app.setNodeVisibility();
          app.tagClusters();
          app.computeDegree();
          setTimeout(function(){
            session.network.render();
            session.network.force.alpha(0.3).alphaTarget(0).restart();
            session.network.updateStatistics();
            session.loadTime = Date.now() - session.startTime;
            $('.hideForHIVTrace').hide();
            setTimeout(session.network.fit, 1500);
          }, 80);
        };
        reader.readAsText(e.target.files[0], 'UTF-8');
      }
    });

    $('#ExitTab').click(function(){ window.open('','_self').close(); });

    $('#FindTab').click(function(e){ $('#search').focus(); });

    $('#AddDataTab').click(function(){ app.launchView('files'); });

    $('#RevealAllTab').click(function(e) {
      session.data.clusters.forEach(function(c){ c.visible = 1; });
      $('#HideSingletons').prop('checked', false).parent().removeClass('active');
      $('#ShowSingletons').prop('checked', true).parent().addClass('active');
      app.setLinkVisibility();
      app.setNodeVisibility();
    });

    $('.viewbutton').click(function(){ app.launchView($(this).data('href')); });

    $('#ReloadTab').click(function(){ window.location.reload(true); });

    $('#FullScreenTab').click(function(){ screenfull.toggle(); });

    $('#computeMST').click(function(){
      //TODO: Write
      $('.showForNotMST').fadeOut(function(){
        $('.showForMST').fadeIn();
      });
    });

    $('#showMSTLinks, #showAllLinks').change(function(){
      app.setLinkVisibility();
      app.tagClusters();
      if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
      app.computeDegree();
    })

    $('#ShowSingletons, #HideSingletons').change(app.setNodeVisibility);

    app.updateThresholdHistogram = function(){
      var width = 280,
          height = 48,
          svg = d3.select('svg#link-threshold-sparkline')
            .html(null)
            .attr('width', width)
            .attr('height', height);

      var lsv = $('#linkSortVariable').val(),
          n = session.data.links.length,
          max = Number.MIN_SAFE_INTEGER,
          min = Number.MAX_SAFE_INTEGER,
          data = Array(n);
      for(var i = 0; i < n; i++){
        var x = parseFloat(session.data.links[i][lsv]);
        data[i] = x;
        if(x < min) min = x;
        if(x > max) max = x;
      }
      var range = max - min;

      var x = d3.scaleLinear()
        .domain([min, max])
        .range([0, width]);

      var bins = d3.histogram()
          .domain(x.domain())
          .thresholds(x.ticks(40))
          (data);

      var y = d3.scaleLinear()
          .domain([0, d3.max(bins, function(d) { return d.length; })])
          .range([height, 0]);

      var bar = svg.selectAll('.bar')
        .data(bins)
        .enter().append('g')
          .attr('class', 'bar')
          .attr('transform', function(d) { return 'translate(' + x(d.x0) + ',' + y(d.length) + ')'; });

      bar.append('rect')
          .attr('x', 1)
          .attr('width', 6)
          .attr('height', function(d) { return height - y(d.length); });

      function updateThreshold(){
        var x = d3.mouse(svg.node())[0];
        session.state.linkThreshold = x / width * range + min;
        $('#default-link-threshold').val(parseFloat(session.state.linkThreshold.toLocaleString()));
        $(window).trigger('updateThreshold');
      }

      svg.on('click', function(){
        updateThreshold();
        app.setLinkVisibility();
        app.tagClusters();
        if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
        app.computeDegree();
        session.network.render();
        session.network.updateStatistics();
        session.network.force.alpha(0.3).alphaTarget(0).restart();
      });

      svg.on('mousedown', function(){
        d3.event.preventDefault();
        svg.on('mousemove', updateThreshold);
        svg.on('mouseup', function(){
          app.setLinkVisibility();
          app.tagClusters();
          if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
          app.computeDegree();
          session.network.render();
          session.network.updateStatistics();
          session.network.force.alpha(0.3).alphaTarget(0).restart();
          svg
            .on('mousemove', null)
            .on('mouseup', null);
        });
      });

      session.state.linkThreshold = parseFloat($('#defaultDistanceThreshold').val());
      $('#default-link-threshold').val(parseFloat(session.state.linkThreshold.toLocaleString()));
      $(window).trigger('updateThreshold');
    };

    $('#linkSortVariable').on('change', app.updateThresholdHistogram);

    $('#default-link-threshold').on('input', function(){
      app.setLinkVisibility();
      app.tagClusters();
      if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
      app.computeDegree();
      $(window).trigger('updateThreshold');
    });

    $('#export-data').click(function(){
      var mime = 'application/json;';
      var format = $('#export-file-format').val();
      var name = $('#export-file-name').val();
      var blob = new Blob([app.exportHIVTRACE()], {type: mime + 'charset=utf-8'});
      saveAs(blob, name + '.' + format);
    });

    $('form').on('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        e.stopPropagation();
      }
    });

    $('#search').on('input', function(e){
      if(e.target.value === ''){
        session.data.nodes.forEach(function(n){ n.selected = 0; });
      } else {
        session.data.nodes.forEach(function(n){ n.selected = (n.id.indexOf(e.target.value)>-1); });
        if(!session.data.nodes.some(function(n){ return n.selected; })) alertify.warning('No matches!');
      }
      $(window).trigger('node_selected');
    });

    $(document).on('keydown', function(e){
      if(e.ctrlKey && e.key === 'f'){
        e.preventDefault();
        $('#search').focus();
      }
    });

    $(window).on('resize', function(){ layout.root.setSize(); });
  });

  alertify.defaults.transition = 'slide';
  alertify.defaults.theme.ok = 'btn btn-primary';
  alertify.defaults.theme.cancel = 'btn btn-danger';
  alertify.defaults.theme.input = 'form-control';
  </script>

</body>
</html>
