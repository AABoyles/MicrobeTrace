<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MicrobeTrace</title>
  <script async src="https://googletagmanager.com/gtag/js?id=UA-116308624-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-116308624-1');
  </script>
  <link rel="icon" type="image/png" href="img/icon.ico" />
  <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/golden-layout/src/css/goldenlayout-base.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/golden-layout/src/css/goldenlayout-light-theme.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/chosen-js/chosen.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/alertifyjs/build/css/alertify.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/open-iconic/font/css/open-iconic-bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="node_modules/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/main.css" />
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-xl navbar-light bg-light">
    <ul class="nav mr-auto">
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">File</a>
        <div class="dropdown-menu">
          <a href="#" id="SaveDataTab" class="dropdown-item" data-toggle="modal" data-target="#save_modal">Save</a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <input type="file" class="d-none" id="OpenTab" />
            <label class="mb-0 w-100" for="OpenTab">Open</label>
          </a>
          <a href="#" id="FileTab" class="dropdown-item">New</a>
        </div>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link py-0" data-toggle="modal" data-target="#global_settings_modal">Settings</a>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">View</a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item viewbutton" data-href="2d_network">2D Network</a>
          <a href="#" class="dropdown-item viewbutton" data-href="3d_network">3D Network</a>
          <a href="#" class="dropdown-item viewbutton" data-href="histogram">Histogram</a>
          <a href="#" class="dropdown-item viewbutton" data-href="table">Table</a>
          <a href="#" class="dropdown-item viewbutton" data-href="bubbles">Bubbles</a>
          <a href="#" class="dropdown-item viewbutton" data-href="flow_diagram">Flow Diagram</a>
          <a href="#" class="dropdown-item viewbutton" data-href="scatterplot">Scatterplot</a>
          <a href="#" class="dropdown-item viewbutton" data-href="waterfall">Waterfall</a>
          <a href="#" class="dropdown-item viewbutton" data-href="geo_map">Map</a>
          <a href="#" class="dropdown-item viewbutton" data-href="gantt">Gantt</a>
          <a href="#" class="dropdown-item viewbutton" data-href="timeline">Timeline</a>
          <div class="dropdown-divider showForSequence"></div>
          <a href="#" class="dropdown-item viewbutton showForSequence" data-href="sequences">Sequences</a>
          <a href="#" class="dropdown-item viewbutton showForSequence" data-href="heatmap">Heatmap</a>
          <a href="#" class="dropdown-item viewbutton showForSequence" data-href="phylogenetic_tree">Phylogenetic Tree</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Window</a>
        <div class="dropdown-menu">
          <a href="#" id="FullScreenTab" class="dropdown-item">Toggle Full Screen</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle py-0" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Help</a>
        <div class="dropdown-menu">
          <a href="#" id="HelpTab" class="viewbutton dropdown-item" data-href="help">Help</a>
          <a href="https://github.com/CDCGov/WebMicrobeTrace/issues/new" class="dropdown-item ifOnline" target="_blank">Report Bug</a>
          <div class="dropdown-divider ifOnline"></div>
          <a href="#" id="AboutTab" class="dropdown-item" data-toggle="modal" data-target="#about-modal">About</a>
        </div>
      </li>
    </ul>
    <form class="navbar-form navbar-right" role="search">
      <input type="search" id="search" class="form-control py-0" placeholder="Search" />
    </form>
  </nav>

  <div id="licenseAgreement" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="licenseAgreement">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="licenseAgreement" class="modal-title">License Agreement</h5>
        </div>
        <div class="modal-body">
          <pre>The material embodied in this software is provided to you "As-is" and without
warranty of any kind, express, implied or otherwise, including without
limitation, any warranty of fitness for a particular purpose. In no event shall
the Centers for Disease Control and Prevention (CDC) or the United States (U.S.)
government be liable to you or anyone else for any direct, special, incidental,
indirect or consequential damages of any kind, or any damages whatsoever,
including without limitation, loss of profit, loss of use, savings or revenue,
or the claims of third parties, whether or not CDC or the U.S. Government has
been advised of the possibility of such loss, however caused and on any theory
of liability, arising out of or in connection with the possession, use or
performance of this software.</pre>
          <p>Please Click "Accept" to accept this agreement, or "Reject" to close this application.</p>
        </div>
        <div class="modal-footer">
          <button id="rejectAgreement" type="button" class="btn btn-danger" data-dismiss="modal">Reject</button>
          <button id="acceptAgreement" type="button" class="btn btn-primary" data-dismiss="modal">Accept</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="loadingInformationModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Loading File</h5>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <img src="img/1DNA.gif" alt="Loading Spinner" />
          </div>
          <a class="btn btn-primary" data-toggle="collapse" href="#collapseDetails" role="button" aria-expanded="false" aria-controls="collapseDetails">Details</a>
          <div class="collapse" id="collapseDetails">
            <div id="loadingInformation" class="card card-body"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="main_panel" class="pane-container pane-horizontal">
    <noscript class="container-fluid">
      <div class="jumbotron">
        <h1>Sorry!</h1>
        <p class="lead">MicrobeTrace requires Javascript to run. Please enable Javascript and refresh MicrobeTrace.</p>
      </div>
    </noscript>
    <div id="group-key-wrapper">
      <table id="group-key" class="floater"></table>
    </div>
    <div id="group-key-context" class="dropdown-menu">
      <a href="#" id="group-key-hide" class="dropdown-item">Hide</a>
    </div>
    <div id="networkStatistics">
      <table>
        <tbody>
          <tr>
            <td class="text-right">
              <span id="numberOfNodes"></span>
              (<span id="numberOfSelectedNodes"></span>)
            </td>
            <td>Nodes (Selected)</td>
          </tr>
          <tr>
            <td id="numberOfVisibleLinks" class="text-right"></td>
            <td>Links</td>
          </tr>
          <tr>
            <td id="numberOfDisjointComponents" class="text-right"></td>
            <td>Clusters</td>
          </tr>
          <tr id="singletonsRow">
            <td id="numberOfSingletonNodes" class="text-right"></td>
            <td>Singletons</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="hide_stats_context" class="dropdown-menu">
      <a href="#" id="hideStats" class="dropdown-item">Hide</a>
    </div>
  </div>

  <span id="tooltip"></span>

  <div id="global_settings_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Global Configurations</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item active">
              <a class="nav-link active" id="global-tab" data-toggle="tab" href="#global-config" role="tab" aria-controls="home" aria-selected="true">Filtering</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="color-tab" data-toggle="tab" href="#color-config" role="tab" aria-controls="home" aria-selected="true">Coloring</a>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="global-config" role="tabpanel" aria-labelledby="global-tab">
              <div class="form-group row">
                <div class="col-4"><label data-toggle="tooltip" title="By what algorithm would you like to prune links from the network?">Prune With</label></div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col">
                      <input type="radio" name="NNOptions" id="links-show-all" autocomplete="off" checked> None
                    </label>
                    <label class="btn btn-light col">
                      <input type="radio" name="NNOptions" id="links-show-nn" autocomplete="off"> Nearest Neighbor
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label for="links-filter-variable" data-toggle="tooltip" title="By what variable would you like to prune links from the network?">Filter Links on</label></div>
                <div class="col-8"><select id="links-filter-variable" class="custom-select custom-select-sm linkVariables"><option value="distance" selected>Distance</option></select></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><a data-toggle="tooltip" title="What's the maximum genetic distance you're willing to call a link?">Filtering Threshold</a></div>
                <div class="col-8"><svg id="link-threshold-sparkline"></svg></div>
                <div class="col-8 offset-4"><input type="number" class="form-control custom-select-sm" id="link-threshold" value="0.015" step="0.001" /></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label for="ShowSingletons" data-toggle="tooltip" title="Would you like to show or hide nodes with no visible links?">Singletons</label></div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col">
                      <input type="radio" name="singletons" id="ShowSingletons" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-light col">
                      <input type="radio" name="singletons" id="HideSingletons" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-4">Reveal</div>
                <div class="col-8">
                  <a href="#" class="btn btn-light btn-sm w-100" id="RevealAllTab" role="button">Everything</a>
                </div>
              </div>
              <hr />
              <div class="form-group row">
                <div class="col-4"><label data-toggle="tooltip" title="Display a table of overview statistics for the network">Statistics</label></div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col">
                      <input type="radio" name="network-statistics-visibility" id="network-statistics-show" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-light col">
                      <input type="radio" name="network-statistics-visibility" id="network-statistics-hide" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="color-config" role="tabpanel" aria-labelledby="color-tab">
              <div class="form-group row">
                <div class="col-4"><label for="node-color-variable" data-toggle="tooltip" title="What color should the nodes be?">Color Nodes By</label></div>
                <div class="col-8"><select id="node-color-variable" class="custom-select custom-select-sm nodeVariables"><option>None</option></select></div>
              </div>
              <div id="node_color_value_row" class="form-group row">
                <div class="col-4"><label for="node-color" data-toggle="tooltip" title="What color should the nodes be?">Nodes</label></div>
                <div class="col-8"><input type="color" id="node-color" class="custom-select custom-select-sm" value="#1f77b4" /></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label data-toggle="tooltip" title="What color should the links be?">Color Links By</label></div>
                <div class="col-8"><select id="link-color-variable" class="custom-select custom-select-sm linkVariables"><option>None</option></select></div>
              </div>
              <div id="link-color-row" class="form-group row">
                <div class="col-4"><label for="link-color" data-toggle="tooltip" title="What color should the links be?">Links</label></div>
                <div class="col-8"><input type="color" id="link-color" class="custom-select custom-select-sm" value="#a6cee3" /></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label for="selected-color" data-toggle="tooltip" title="What color should denote selection?">Selected</label></div>
                <div class="col-8"><input type="color" id="selected-color" class="custom-select custom-select-sm" value="#ff8300" /></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label for="background-color" data-toggle="tooltip" title="What color should the background be?">Background</label></div>
                <div class="col-8"><input type="color" id="background-color" class="custom-select custom-select-sm" value="#ffffff" /></div>
              </div>
              <div class="form-group row">
                <div class="col-4"><label data-toggle="tooltip" title="Display the table of colors">Color Table</label></div>
                <div class="col-8">
                  <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
                    <label class="btn btn-light active col">
                      <input type="radio" name="colorTableShowHide" id="color-table-show" autocomplete="off" checked> Show
                    </label>
                    <label class="btn btn-light col">
                      <input type="radio" name="colorTableShowHide" id="color-table-hide" autocomplete="off"> Hide
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="btn-group" data-toggle="buttons">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Done</button>
          </div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="save_modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="save-file-name" class="form-control form-control-sm" placeholder="Filename" />
            </div>
            <div class="col-3">
              <select id="save-file-format" class="form-control form-control-sm">
                <option selected>microbetrace</option>
                <option>hivtrace</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="save-data" class="btn btn-primary" data-dismiss="modal">Save</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">About MicrobeTrace</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <h3>MicrobeTrace <small id="version"></small></h3>
          <p>MicrobeTrace is a desktop application that renders existing data from high-risk contact networks in an easy-to-use Graphical User Interface (GUI). The network visualization can be customized according to supplemental data sources and mathematical inferences like the most probable transmission pathways. MicrobeTrace is a highly responsive, visual sequence analytics tool which can reduce the gap between data production and analytics and help you to discover, understand, and display relationships (links) between patients (nodes). MicrobeTrace can be deployed on laptops to locations without any Internet access, thereby reducing both the startup cost and analysis time and effort.</p>
          <p class="ifOnline"><a href="https://github.com/CDCGov/WebMicrobeTrace/wiki" target="_blank">Click Here to Learn More</a></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts/polyfills.js"></script>
  <script src="node_modules/underscore/underscore-min.js"></script>
  <script src="node_modules/vue/dist/vue.min.js"></script>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="node_modules/golden-layout/dist/goldenlayout.min.js"></script>
  <script src="node_modules/papaparse/papaparse.min.js"></script>
  <script src="node_modules/xss/dist/xss.min.js"></script>
  <script src="node_modules/d3/dist/d3.min.js"></script>
  <script src="node_modules/d3-force-attract/dist/d3-force-attract.min.js"></script>
  <script src="node_modules/d3-symbol-extra/build/d3-symbol-extra.min.js"></script>
  <script src="node_modules/plotly.js/dist/plotly.min.js"></script>
  <script src="node_modules/alertifyjs/build/alertify.min.js"></script>
  <script src="vendor/FileSaver.min.js"></script>
  <script src="node_modules/html2canvas/dist/html2canvas.min.js"></script>
  <script src="node_modules/screenfull/dist/screenfull.js"></script>
  <script src="node_modules/clipboard/dist/clipboard.min.js"></script>
  <script src="vendor/bootstrap-filestyle.min.js"></script>
  <script src="node_modules/d3-force-3d/build/d3-force-3d.min.js"></script>
  <script src="node_modules/leaflet/dist/leaflet.js"></script>
  <script src="node_modules/chosen-js/chosen.jquery.min.js"></script>
  <script src="node_modules/xlsx/dist/xlsx.full.min.js"></script>
  <script src="node_modules/alignment-viewer/dist/alignment-viewer.min.js"></script>
  <script src="node_modules/moment/min/moment-with-locales.min.js"></script>
  <script src="vendor/shpwrite.js"></script>
  <script src="node_modules/d3-sankey/build/d3-sankey.min.js"></script>
  <script src="vendor/neighbor-joining.js"></script>
  <script src="node_modules/phylocanvas/dist/phylocanvas.min.js"></script>
  <script src="scripts/common.js"></script>
  <script>
  $(function(){
    'use strict';

    $.getJSON('package.json', function(r){
      app.manifest = r;
      $('#version').html(r.version);
    });

    if(navigator.onLine){
      $('#HelpTab')
        .removeClass('viewbutton')
        .attr('href', 'https://github.com/CDCGov/WebMicrobeTrace/wiki')
        .attr('target', '_blank');
      $('.ifOnline').show();
      if(window.applicationCache.status !== window.applicationCache.UNCACHED){
        window.applicationCache.update();
        if(window.applicationCache.status === window.applicationCache.UPDATEREADY){
          window.applicationCache.swapCache();
        }
      }
    }

    window.session = app.sessionSkeleton();

    window.layout = new window.GoldenLayout({
      settings: {
        selectionEnabled: true,
        showPopoutIcon: false
      },
      content: [{
        type: 'stack',
        content: []
      }]
    }, $('#main_panel'));

    layout.init();

    layout.contentItems = [];

    app.launchView('files');

    // Before anything else gets done, ask the user to accept the legal agreement
    if(!localStorage.getItem('licenseAccepted')){
      $('#acceptAgreement').on('click', function(){
        // Set that agreement in localStorage
        localStorage.setItem('licenseAccepted', new Date());
      });
      $('#rejectAgreement').on('click', function(){
        // If you don't agree, no app for you!
        //TODO: Show a message indicating you are not permitted to use the app without agreeing to the terms of use.
      });
      // No hacking around the agreement.
      $('#licenseAgreement').modal({
        backdrop: 'static',
        keyboard: false
      });
    }

    // Let's set up the Nav Bar
    $('#FileTab').on('click', function(){ window.location.reload() });

    $('#save-data').on('click', function(){
      var format = $('#save-file-format').val();
      var name = $('#save-file-name').val();
      var data = format == 'microbetrace' ? JSON.stringify(session) : app.exportHIVTRACE();
      var blob = new Blob([data], {type: 'application/json;charset=utf-8'});
      saveAs(blob, name + '.' + format);
    });

    $('#OpenTab').on('change', function(e){
      if(e.target.files.length > 0){
        var startTime = Date.now();
        var parts = e.target.files[0].name.split('.');
        var extension = parts[parts.length - 1];
        var reader = new FileReader();
        if(extension == 'microbetrace'){
          reader.onloadend = function(out){
            session = JSON.parse(out.target.result);
            session.startTime = startTime;
            session.style.widgets = Object.assign({}, app.defaultWidgets, session.style.widgets);
            $('#node-color-variable').change();
            $('#link-color-variable').change();
            app.finishUp();
          };
        } else {
          reader.onloadend = function(out){
            session = app.sessionSkeleton();
            session.startTime = startTime;
            app.parseHIVTrace(JSON.parse(out.target.result));
            app.finishUp();
          };
        }
        reader.readAsText(e.target.files[0], 'UTF-8');
      }
    });

    $('.viewbutton').on('click', function(){ app.launchView($(this).data('href')); });

    $('#FullScreenTab').on('click', function(){ screenfull.toggle(); });

    $('[name="NNOptions"]').on('change', function(){
      app.updateNetwork($('#HideSingletons').is(':checked'));
    });

    $('#links-filter-variable').on('change', function(){
      app.updateThresholdHistogram();
      app.updateStatistics();
      $(window).trigger('link-threshold-change');
    });

    app.updateThresholdHistogram = function(){
      var width = 280,
          height = 48,
          svg = d3.select('svg#link-threshold-sparkline')
            .html(null)
            .attr('width', width)
            .attr('height', height);

      var lsv = $('#links-filter-variable').val(),
          n = session.data.links.length,
          max = Number.MIN_SAFE_INTEGER,
          min = Number.MAX_SAFE_INTEGER,
          data = Array(n);
      for(var i = 0; i < n; i++){
        var x = parseFloat(session.data.links[i][lsv]);
        data[i] = x;
        if(x < min) min = x;
        if(x > max) max = x;
      }
      var range = max - min;
      var ticks = 40;

      var x = d3.scaleLinear()
        .domain([min, max])
        .range([0, width]);

      var bins = d3.histogram()
          .domain(x.domain())
          .thresholds(x.ticks(ticks))
          (data);

      var y = d3.scaleLinear()
          .domain([0, d3.max(bins, function(d) { return d.length; })])
          .range([height, 0]);

      var bar = svg.selectAll('.bar').data(bins)
        .enter().append('g')
          .attr('class', 'bar')
          .attr('transform', function(d) { return 'translate(' + x(d.x0) + ',' + y(d.length) + ')'; });

      bar.append('rect')
          .attr('x', 1)
          .attr('width', 6)
          .attr('height', function(d) { return height - y(d.length); });

      function updateThreshold(){
        var xc = d3.mouse(svg.node())[0];
        session.state.linkThreshold = xc / width * range * 1.05 + min;
        $('#link-threshold').val(parseFloat(session.state.linkThreshold.toLocaleString()));
      }

      svg.on('click', function(){
        updateThreshold();
        app.setLinkVisibility();
        app.tagClusters();
        if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
        app.computeDegree();
        app.updateStatistics();
        $(window).trigger('link-threshold-change');
      });

      svg.on('mousedown', function(){
        d3.event.preventDefault();
        svg.on('mousemove', updateThreshold);
        svg.on('mouseup mouseleave', function(){
          app.setLinkVisibility();
          app.tagClusters();
          if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
          app.computeDegree();
          app.updateStatistics();
          $(window).trigger('link-threshold-change');
          svg
            .on('mousemove', null)
            .on('mouseup', null)
            .on('mouseleave', null);
        });
      });
      session.state.linkThreshold = parseFloat($('#defaultDistanceThreshold').val());
      $('#link-threshold').val(parseFloat(session.state.linkThreshold.toLocaleString()));
      $(window).trigger('link-threshold-change');
    };

    $('#ShowSingletons, #HideSingletons').on('change', e => {
      app.setNodeVisibility();
      app.updateStatistics();
    });

    $('#links-show-nn, #links-show-all').on('change', e => {
      app.updateStatistics();
      $(window).trigger('link-threshold-change');
    });

    $('#link-threshold').on('input', function(){
      app.setLinkVisibility();
      app.tagClusters();
      if($('#HideSingletons').is(':checked')) app.setNodeVisibility();
      app.computeDegree();
      app.updateStatistics();
      $(window).trigger('link-threshold-change');
    });

    $('#network-statistics-hide').parent().on('click', function(){
      $('#networkStatistics').fadeOut();
    });

    $('#network-statistics-show').parent().on('click', function(){
      app.updateStatistics();
      $('#networkStatistics').fadeIn();
    });

    $('#networkStatistics').on('contextmenu', function(e){
      e.preventDefault();
      $('#hide_stats_context').css({
        top: e.clientY,
        left: e.clientX,
        display: 'block'
      });
    });

    $('#hideStats').on('click', function(e){
      $(this).parent().hide();
      $('#network-statistics-hide').parent().click();
    });

    $('#RevealAllTab').on('click', function(e){
      session.data.clusters.forEach(function(c){ c.visible = true; });
      app.setLinkVisibility();
      $('#ShowSingletons').parent().click(); //calls app.setNodeVisibility();
    });

    $('#node-color-variable')
      .val(session.style.widgets['node-color-variable'])
      .on('change', function(e){
        let variable = e.target.value;
        session.style.widgets['node-color-variable'] = variable;
        if(variable === 'None'){
          $('#node_color_value_row').slideDown();
          $('#nodeColors').remove();
          $(window).trigger('node-color-change');
          return;
        }
        $('#node_color_value_row').slideUp();
        $('#nodeColors').remove();
        let table = $('<tbody id="nodeColors"></tbody>').appendTo('#group-key');
        table.append('<tr><th contenteditable>Node '+app.titleize(variable)+'</th><th>Color</th><tr>');
        let values = _.uniq(app.getVisibleNodes().map(d => d[variable])).sort();
        session.style.nodeColorMap = d3.scaleOrdinal(session.style.nodeColors).domain(values);
        values.forEach((value, i) => {
          let input = $('<input type="color" value="'+session.style.nodeColorMap(value)+'" />')
            .on('change', function(evt){
              session.style.nodeColors.splice(i, 1, evt.target.value);
              session.style.nodeColorMap = d3.scaleOrdinal(session.style.nodeColors).domain(values);
              $(window).trigger('node-color-change');
            });
          let cell = $('<td></td>').append(input);
          let row = $('<tr><td contenteditable>'+app.titleize(''+value)+'</td></tr>').append(cell);
          table.append(row);
        });
        $(window).trigger('node-color-change');
      });

    $('#node-color')
      .on('change', function(e){
        session.style.widgets['node-color'] = e.target.value;
        $(window).trigger('node-color-change');
      })
      .val(session.style.widgets['node-color']);

    $('#link-color-variable')
      .val(session.style.widgets['link-color-variable'])
      .on('change', function(e){
        let variable = e.target.value;
        session.style.widgets['link-color-variable'] = variable;
        if(variable === 'None'){
          $('#link-color-row').slideDown();
          $('#linkColors').remove();
          $(window).trigger('link-color-change');
          return;
        }
        $('#link-color-row').slideUp();
        $('#linkColors').remove();
        let values = [];
        if(variable === 'origin'){
          session.data.links.forEach(l => {
            l.origin.forEach(o => {
              if(!values.includes(o)) values.push(o);
            });
          });
        } else {
          session.data.links.forEach(l => {
            if(!values.includes(l[variable])) values.push(l[variable]);
          });
        }
        let table = $('<tbody id="linkColors"></tbody>').appendTo('#group-key');
        table.append('<tr><th contenteditable>Link '+app.titleize(variable)+'</th><th>Color</th><tr>');
        if(_.isNumber(session.data.links[0][variable])){
          values.sort((a, b) => a - b);
        } else {
          values.sort();
        }
        session.style.linkColorMap = d3.scaleOrdinal(session.style.linkColors).domain(values);
        values.forEach((value, i) => {
          let input = $('<input type="color" value="'+session.style.linkColorMap(value)+'" />')
            .on('change', function(evt){
              session.style.linkColors.splice(i, 1, evt.target.value);
              session.style.linkColorMap = d3.scaleOrdinal(session.style.linkColors).domain(values);
              $(window).trigger('link-color-change');
            });
          let cell = $('<td></td>').append(input);
          let row = $('<tr><td contenteditable>'+app.titleize(''+value)+'</td></tr>').append(cell);
          table.append(row);
        });
        $(window).trigger('link-color-change');
      });

    $('#link-color').on('change', function(e){
      session.style.widgets['link-color'] = e.target.value;
      $(window).trigger('link-color-change');
    });

    $('#selected-color').on('change', function(e){
      session.style.widgets['selected-color'] = e.target.value;
      session.style.widgets['selected-color-contrast'] = app.contrastColor(e.target.value);
      $(window).trigger('selected-color-change');
    });

    $('#background-color').on('change', function(e){
      session.style.widgets['background-color'] = e.target.value;
      session.style.widgets['background-color-contrast'] = app.contrastColor(e.target.value);
      $(window).trigger('background-color-change');
    });

    $('#color-table-show').parent().on('click', function(){
      $('#group-key').fadeIn();
    });

    $('#color-table-hide').parent().on('click', function(){
      $('#group-key').fadeOut();
    });

    $('#group-key-wrapper').on('contextmenu', function(e){
      e.preventDefault();
      $('#group-key-context').css({
        top: e.clientY,
        left: e.clientX,
        display: 'block'
      });
    });

    $('#group-key-hide').on('click', function(e){
      $(this).parent().hide();
      $('#color-table-hide').parent().click();
    });

    $('form').on('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        e.stopPropagation();
      }
    });

    $('#search').on('input', function(e){
      if(e.target.value === ''){
        session.data.nodes.forEach(function(n){ n.selected = 0; });
      } else {
        session.data.nodes.forEach(function(n){ n.selected = (n.id.indexOf(e.target.value)>-1); });
        if(!session.data.nodes.some(function(n){ return n.selected; })) alertify.warning('No matches!');
      }
      $(window).trigger('node_selected');
    });

    $(document).on('keydown', function(e){
      if(e.ctrlKey && e.key === 'f'){
        e.preventDefault();
        $('#search').focus();
      }
    });

    layout.on('stateChanged', function(){ session.layout = layout.toConfig(); });

    $(window)
      .on('node_selected', function(){
        $('#numberOfSelectedNodes').text(session.data.nodes.filter(d => d.selected).length.toLocaleString());
      })
      .on('click', function(){
        $('#hide_stats_context #group-key-context').hide();
      })
      .on('resize', function(){
        layout.root.setSize();
      })
      .on('beforeunload', function (e){
        e.preventDefault();
        e.returnValue = 'Are you certain? This session will be lost!';
      });
  });

  alertify.defaults.transition = 'slide';
  alertify.defaults.theme.ok = 'btn btn-primary';
  alertify.defaults.theme.cancel = 'btn btn-danger';
  alertify.defaults.theme.input = 'form-control';
  </script>

</body>
</html>
